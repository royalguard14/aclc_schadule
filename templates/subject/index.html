{% extends"layouts/master.html" %}
{% block crump1 %}SUBJECT{% endblock %}
{% block crump2 %}Subject{% endblock %}
{% block content %}



<div class="row">
  <div class="col-lg-4">
    <div class="card">
      <div class="card-header border-0">
        <div class="d-flex justify-content-between">
          <h3 class="card-title">Add New Subject</h3>
        </div>
      </div>
      <div class="card-body">
        <form id="addForm">
          <div class="card-body">
            <div class="form-group">
              <label for="departmentAcronym">Subject Name</label>
              <input type="text" name="subject_name" id="subject_name" class="form-control" required>
            </div>
            <div class="row">
              <div class="form-group col-sm-6">
                <label >Course</label>
                <select id="select_course" class="form-control select2bs4" name="select_course">
                </select>
              </div>
              <div class="form-group col-sm-6">
                <label >Subj Code</label>
                <input type="text" name="subject_code" id="subject_code" class="form-control" required>
              </div>
            </div>
            <div class="row">
              <div class="form-group col-sm-6">
                <label >Lec. Unit</label>
                <input type="number" name="lec_unit" id="lec_unit" class="form-control" required>

              </div>
              <div class="form-group col-sm-6">
                <label >Lab. Unit</label>
                <input type="number" name="lab_unit" id="lab_unit" class="form-control" required>
              </div>
            </div>

            <div class="row">
              <div class="form-group col-sm-6">
                <label >Year</label>
                <select id="year" class="form-control select2bs4" name="year">
                  <option value="0" selected="selected"> Select Year</option>
                  <option value="1st" > First Year</option>
                  <option value="2nd" > Second Year</option>
                  <option value="3rd" > Third Year</option>
                  <option value="4th" > Forth Year</option>
                </select>

              </div>
              <div class="form-group col-sm-6">
                <label >Semester</label>
                <select id="sem" class="form-control select2bs4" name="sem">
                  <option value="0" selected="selected"> Select Semester</option>
                  <option value="1st" > First Semester</option>
                  <option value="2nd" > Second Semester</option>
                  <option value="3rd" > Third Semester</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label for="mod">Pre-requisite</label>   
              <textarea class="form-control" id="pre" name="pre" style="resize: none; height: 10em;" placeholder="No function yet"></textarea>                    
            </div> 

          </div>
          <!-- /.card-body -->
          <button type="submit" class="btn btn-primary float-right" id="save-button">Submit</button>
        </form>
      </div>
    </div>
    <!-- /.card -->
  </div>
  <!-- /.col-md-6 -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header border-0">
        <div class="d-flex justify-content-between">
          <h3 class="card-title">Subject List</h3>
        </div>
      </div>
      <div class="card-body">
        <table id="excel_table" class="table table-bordered table-striped">
          <thead>
            <tr>
              <th>#</th>
              <th>Course code</th>
              <th>Subject Name</th>
              <th>Subject code</th>
              <th>Unit</th>
              <th>Pre-requisite</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="load-table">
            {% for x in subj_list %}
              {% set units = x[4].split("|") %}
              {% set ys = x[6].split("|") %}
            <tr>
              <td>{{loop.index}}</td>
              <td>{{course_list[x[1]]}}</td>
              <td>{{x[2]}}</td>
              <td>{{x[3]}}</td>
              <td>{{ units[0]|int + units[1]|int }}</td>
              <td>{{x[5]}}</td>
              <td>

                <div class="btn-group"><a href="#" type="button" class="btn btn-outline-info btn-block btn-xs" id ="edit" data-id="{{x[0]}}"  data-ccode ="{{x[1]}}" data-sname ="{{x[2]}}" data-scode ="{{x[3]}}" data-lac ="{{units[0]|int}}" data-lab ="{{units[1]|int}}" data-yr ="{{ys[0]}}" data-sem ="{{ys[1]}}" data-pre ="{{x[5]}}"><i class="fa fa-pencil"></i> Edit</a></div>
                <div class="btn-group"><a href="#" type="button" class="btn btn-outline-danger btn-block btn-xs"  id="delete" data-id="{{x[0]}}" ><i class="fa fa-trash"></i> delete</a></div></td>
              </td>
            </tr>

            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <!-- /.card -->
  </div>
  <!-- /.col-md-6 -->
</div>
<!-- /.row -->
<!-- Modal -->
<div class="modal fade" id="modal-sm">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">EDIT SUBJECT</h4>
      </div>
      <div class="modal-body">
        <form action="" id="edit-form">
          <input type="text" name="sid" id="edit-id" hidden="">
         <div class="form-group">
          <label for="departmentAcronym">Subject Name</label>
          <input type="text" name="subject_name" id="e_subject_name" class="form-control" required>
        </div>
        <div class="row">
          <div class="form-group col-sm-6">
            <label >Course</label>
            <select id="e_select_course" class="form-control select2bs4" name="dept_id">
            </select>
          </div>
          <div class="form-group col-sm-6">
            <label >Subj Code</label>
            <input type="text" name="subject_code" id="e_subject_code" class="form-control" required>
          </div>
        </div>
        <div class="row">
          <div class="form-group col-sm-6">
            <label >Lec. Unit</label>
            <input type="number" name="lec_unit" id="e_lec_unit" class="form-control" required>

          </div>
          <div class="form-group col-sm-6">
            <label >Lab. Unit</label>
            <input type="number" name="lab_unit" id="e_lab_unit" class="form-control" required>
          </div>
        </div>

            <div class="row">
              <div class="form-group col-sm-6">
                <label >Year</label>
                <select id="e_year" class="form-control select2bs4" name="year">
                  <option value="0" selected="selected"> Select Year</option>
                  <option value="1st" > First Year</option>
                  <option value="2nd" > Second Year</option>
                  <option value="3rd" > Third Year</option>
                  <option value="4th" > Forth Year</option>
                </select>

              </div>
              <div class="form-group col-sm-6">
                <label >Semester</label>
                <select id="e_sem" class="form-control select2bs4" name="sem">
                  <option value="0" selected="selected"> Select Semester</option>
                  <option value="1st" > First Semester</option>
                  <option value="2nd" > Second Semester</option>
                  <option value="3rd" > Third Semester</option>
                </select>
              </div>
            </div>


        <div class="form-group">
          <label for="mod">Pre-requisite</label>   
          <textarea class="form-control" id="e_pre" name="pre" style="resize: none; height: 10em;" placeholder="No function yet"></textarea>                    
        </div> 

      </form>
    </div>
    <div class="modal-footer justify-content-between">
      <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      <button type="button" class="btn btn-primary" id="edit-submit">Save changes</button>
    </div>
  </div>
  <!-- /.modal-content -->
</div>
<!-- /.modal-dialog -->
</div>
<!-- /.modal -->
{% endblock %}
{% block script %}

<script type="text/javascript">

    function loaddatas2(x){
      $.ajax({
        url :"{{ url_for('courses.for_subselect')}}",
        type :"GET",
        success : function(data){

      
          $("#e_select_course").empty();
     
          var option1 ="<option>Select Course</option>"; 

          $("#e_select_course").append(option1); 
          var len = data.length; 
          if(len > 0){
            for(var i=0; i<len; i++){
              if (data[i][0] == x){
                 var option ="<option value='"+data[i][0]+"' selected>"+data[i][1]+"</option>"; 
              }else{
                 var option ="<option value='"+data[i][0]+"'>"+data[i][1]+"</option>"; 
              }
              $("#e_select_course").append(option);   
            }
          }
        }
      });
    }


//yearupdate
  function loaddatas3(x){
      $.ajax({
        url :"{{ url_for('subjects.yearajax')}}",
        type :"GET",
        success : function(data){
      
          $("#e_year").empty();
     
          var len = data.length; 
          if(len > 0){
            for(var i=0; i<len; i++){
              if (data[i][0] == x){
                 var option ="<option value='"+data[i][0]+"' selected>"+data[i][1]+"</option>"; 
              }else{
                 var option ="<option value='"+data[i][0]+"'>"+data[i][1]+"</option>"; 
              }
              $("#e_year").append(option);   
            }
          }
        }
      });
    }

//yearupdate
  function loaddatas4(x){
      $.ajax({
        url :"{{ url_for('subjects.semajax')}}",
        type :"GET",
        success : function(data){
      
          $("#e_sem").empty();
     
          var len = data.length; 
          if(len > 0){
            for(var i=0; i<len; i++){
              if (data[i][0] == x){
                 var option ="<option value='"+data[i][0]+"' selected>"+data[i][1]+"</option>"; 
              }else{
                 var option ="<option value='"+data[i][0]+"'>"+data[i][1]+"</option>"; 
              }
              $("#e_sem").append(option);   
            }
          }
        }
      });
    }





    // load course select---------------------------------------------
    function load_courseSelect(){
      $.ajax({
        url :"{{ url_for('courses.for_subselect')}}",
        type :"GET",
        success : function(data){
         $("#select_course").empty();
         var option1 ="<option selected="+"selected" +">Select Course</option>"; 
         $("#select_course").append(option1); 
         var len = data.length; 
         if(len > 0){
          for(var i=0; i<len; i++){
            var option ="<option value='"+data[i][0]+"'>"+data[i][1]+"-"+data[i][2]+"</option>"; 
            $("#select_course").append(option);   
          }
        }

      }
    });
    }


    // Store course---------------------------------------------
    $('#save-button').on("click",function(e){
      e.preventDefault();

      var subject_name = $('#subject_name').val();
      var select_course = $('#select_course').val();
      var subject_code = $('#subject_code').val();
      var lec_unit = $('#lec_unit').val();
      var lab_unit = $('#lab_unit').val();
      var pre = $('#pre').val();
      var year = $('#year').val();
      var sem = $('#sem').val();



      if ( subject_name =="" || select_course =="Select Course" || subject_code =="" || lec_unit =="" || lab_unit =="" || year =="0" || sem =="0") {
        switalert('warning', 'All fields are required !');
      }
      else{
        $.ajax({
          url :"{{ url_for('subjects.subj_store')}}",
          type :"POST",
          data : JSON.stringify({
           subject_name : subject_name, 
           select_course : select_course, 
           subject_code : subject_code, 
           lec_unit : lec_unit, 
           lab_unit : lab_unit, 
           pre : pre, 
           year : year,
           sem : sem
         }),

          dataType :"json",
          contentType :"application/json; charset=utf-8",
          success : function(data){
            if (data == 1) {
              load_courseSelect()
              $('#addForm').trigger("reset");
              stoast('Data has been Saved  !', 'success');
            }else{
              switalert('error',"Can't Save Record.");
            }
          }
        });
      }
    });


        // update data---------------------------------------------
        $(document).on("click","#edit", function(e){

          $('#modal-sm').modal('toggle');
          var id = $(this).data("id");
          var subject_name = $(this).data("sname");
          var select_course = $(this).data("ccode");
          var subject_code = $(this).data("scode");
          var lec_unit = $(this).data("lac");
          var lab_unit = $(this).data("lab");
          var pre = $(this).data("pre");
          var year = $(this).data("yr");
          var sem = $(this).data("sem");
          loaddatas2(select_course);
          loaddatas3(year);
          loaddatas4(sem);
          $('#edit-id').val(id);
          $('#e_subject_name').val(subject_name);
          $('#e_subject_code').val(subject_code);
          $('#e_lec_unit').val(lec_unit);
          $('#e_lab_unit').val(lab_unit);
          $('#e_pre').val(pre);
          $('#e_sem').val(sem);
        });



//Update Record------------------------------------------
        $(document).on("click","#edit-submit", function(e){
          e.preventDefault();
          var id =  $('#edit-id').val();
          var subject_name = $('#e_subject_name').val();
          var select_course = $('#e_select_course').val();
          var subject_code = $('#e_subject_code').val();
          var lec_unit = $('#e_lec_unit').val();
          var lab_unit = $('#e_lab_unit').val();
          var pre = $('#e_pre').val();
          var year = $('#e_year').val();
          var sem = $('#e_sem').val();

          if (subject_name =="" || select_course =="Select Course" || subject_code =="" || lec_unit =="" || lab_unit =="" || year =="0" || sem =="0") {
            switalert('warning', 'All fields are required !');
          }else {
            $.ajax({
              url :"{{ url_for('subjects.subj_update')}}",
              type :"POST",
              data : JSON.stringify({
               id : id,
               subject_name : subject_name, 
               select_course : select_course, 
               subject_code : subject_code, 
               lec_unit : lec_unit, 
               lab_unit : lab_unit, 
               pre : pre, 
               year : year,
               sem : sem
             }),
              dataType :"json",
              contentType :"application/json; charset=utf-8",
              success : function(data){
                if (data == 1) {
                  $('#modal-sm').modal('hide');
                  stoast('Data has been Updated  !', 'info');
                }else{
                  switalert('error',"Can't Save Record.");
                }
              }
            });
          }
        });

// delete data---------------------------------------------
        $(document).on("click","#delete", function(e){
          Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
          }).then((result) => {
            if (result.isConfirmed) {
              var course_id = $(this).data("id");
              $.ajax({
                url : "{{ url_for('subjects.subj_destroy')}}",
                type : "POST",
                data : JSON.stringify({id : course_id}),
                dataType : "json",
                contentType : "application/json; charset=utf-8",
                success : function(data){
                  if (data == 1){
                    Swal.fire(
                    'Deleted!',
                    'Your file has been deleted.',
                    'success'
                    )
                  }else{
                    switalert('error', "Can't Delete Record.");
                  }
                }
              });
            }
          })
        });











  </script>


  <script type="text/javascript">
  //execute
  load_courseSelect();

</script>






{% endblock %}